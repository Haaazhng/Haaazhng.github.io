<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="流水线CPU设计, dzhang&#39;s blog">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>流水线CPU设计 | dzhang&#39;s blog</title>
    <link rel="icon" type="image/png" href="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/favicon.png">

    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/css/matery.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/css/my.css">

    <script src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/jquery/jquery.min.js"></script>

    <!-- <script src="https://sdk.jinrishici.com/v2/browser/jinrishici.js"
    charset="utf-8"></script> -->

<meta name="generator" content="Hexo 5.4.2"></head>



   <style>
    body{
       background-image: url(https://cdn.jsdelivr.net/gh/Tokisaki-Galaxy/res/site/medias/background.jpg);
       background-repeat:no-repeat;
       background-size:cover;
       background-attachment:fixed;
    }
</style>



<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">dzhang&#39;s blog</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>时间轴</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>个人中心</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>生活馆</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/musics">
          
          <i class="fas fa-music" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>音乐</span>
        </a>
      </li>
      
      <li>
        <a href="/movies">
          
          <i class="fas fa-film" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>电影</span>
        </a>
      </li>
      
      <li>
        <a href="/series">
          
          <i class="fas fa-tv" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>追剧</span>
        </a>
      </li>
      
      <li>
        <a href="/gallery">
          
          <i class="fas fa-image" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>相册</span>
        </a>
      </li>
      
      <li>
        <a href="/documentary">
          
          <i class="fas fa-video" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>纪录片</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">dzhang&#39;s blog</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			时间轴
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			个人中心
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			生活馆
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/musics " style="margin-left:75px">
				  
				   <i class="fa fas fa-music" style="position: absolute;left:50px" ></i>
			      
		          <span>音乐</span>
                  </a>
                </li>
              
                <li>

                  <a href="/movies " style="margin-left:75px">
				  
				   <i class="fa fas fa-film" style="position: absolute;left:50px" ></i>
			      
		          <span>电影</span>
                  </a>
                </li>
              
                <li>

                  <a href="/series " style="margin-left:75px">
				  
				   <i class="fa fas fa-tv" style="position: absolute;left:50px" ></i>
			      
		          <span>追剧</span>
                  </a>
                </li>
              
                <li>

                  <a href="/gallery " style="margin-left:75px">
				  
				   <i class="fa fas fa-image" style="position: absolute;left:50px" ></i>
			      
		          <span>相册</span>
                  </a>
                </li>
              
                <li>

                  <a href="/documentary " style="margin-left:75px">
				  
				   <i class="fa fas fa-video" style="position: absolute;left:50px" ></i>
			      
		          <span>纪录片</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Haaazhng/Haaazhng.github.io" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Haaazhng/Haaazhng.github.io" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/medias/featureimages/15.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">流水线CPU设计</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="container content">

    
    <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Verilog/">
                                <span class="chip bg-color">Verilog</span>
                            </a>
                        
                            <a href="/tags/RISC-V/">
                                <span class="chip bg-color">RISC-V</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/COD/" class="post-category">
                                COD
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-05-25
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-07-10
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5.5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    23 分
                </div>
                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>本次设计基于单周期CPU的实现，请先移步了解笔者另一篇博客：<a href="/2023/05/25/22462.html" title="单周期CPU设计">单周期CPU设计</a><br>单周期CPU在一个时钟周期内执行一条指令，这就意味着在这个时钟周期中，每个模块只在一小段时间内做了“有意义”的工作，而其余的时间都是空闲的。这显然是对CPU性能的极大浪费，不可容忍，难以饶恕！我们很容易联想到工厂的流水线，类似的，我们使CPU也“流水线”化。所以我们将其分为五个流水线单元：IF，ID，EX，MEM，WB。</p>
<ul>
<li>IF（Instruction Fetch，取指令），核心耗时为指令存储器的读取。</li>
<li>ID（Instruction Decode，译码），包含将指令翻译为各个控制信号并读取寄存器堆，核心耗时为寄存器堆的读取。</li>
<li>EX（Execution，执行），由算术逻辑单元ALU进行运算，得到指令的计算结果，同时计算可能需要的跳转地址，核心耗时为ALU计算。</li>
<li>MEM（Memory，访存），对数据存储器进行读取或写入，核心耗时为数据存储器的读写。</li>
<li>WB（Write Back，回写），将需要写回寄存器堆的数据写入。注意此处耗时与数据存储器写入一样，只考虑准备的时间，因为实际写入是在时钟上升沿进行的。</li>
</ul>
<p>五个单元各司其职，这样就避免了某个模块在工作的时候其余模块在偷懒。所以，本次实验的内容就是在<a href="/2023/05/25/22462.html" title="单周期CPU">单周期CPU</a>的基础上设计和实现五级流水线CPU，使其支持以下10条指令的功能：add、addi、lui、auipc、beq、blt、jal、jalr、lw、sw<br>数据通路为：</p>
<img src="https://gcore.jsdelivr.net/gh/Haaazhng/images/img/202305251653450.png">

<img src="https://gcore.jsdelivr.net/gh/Haaazhng/images/img/202305251452541.png">

<p>以下为部分模块的的设计思路。</p>
<h3 id="控制中枢Ctrl："><a href="#控制中枢Ctrl：" class="headerlink" title="控制中枢Ctrl："></a>控制中枢Ctrl：</h3><img src="https://gcore.jsdelivr.net/gh/Haaazhng/images/img/202305251431064.png">

<p>为了配合处理数据冒险，我们又添加了寄存器读使能信号：rf_re0和rf_re1。当该指令需要读取寄存器的值且该寄存器不是x0时rf_re赋值为1，否则等于0。rf_re会在冒险处理模块Hazard中发挥作用。</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token comment">//rf_re0信号</span>
<span class="token function">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>inst_type<span class="token operator">==</span>Add<span class="token operator">||</span>inst_type<span class="token operator">==</span>Addi<span class="token operator">||</span>inst_type<span class="token operator">==</span>Lw<span class="token operator">||</span>inst_type<span class="token operator">==</span>Sw<span class="token operator">||</span>inst_type<span class="token operator">==</span>Beq<span class="token operator">||</span>inst_type<span class="token operator">==</span>Blt<span class="token operator">||</span>inst_type<span class="token operator">==</span>Jalr<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> inst<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
    rf_re0<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> rf_re0<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> 
<span class="token comment">//rf_re1信号</span>
<span class="token function">if</span><span class="token punctuation">(</span><span class="token punctuation">(</span>inst_type<span class="token operator">==</span>Add<span class="token operator">||</span>inst_type<span class="token operator">==</span>Sw<span class="token operator">||</span>inst_type<span class="token operator">==</span>Beq<span class="token operator">||</span>inst_type<span class="token operator">==</span>Blt<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> inst<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">:</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token operator">!=</span><span class="token number">0</span><span class="token punctuation">)</span>
    rf_re1<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">else</span> rf_re1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="作为段间寄存器的PC："><a href="#作为段间寄存器的PC：" class="headerlink" title="作为段间寄存器的PC："></a>作为段间寄存器的PC：</h3><p>添加一个控制信号stall，当stall高电平时，PC模块暂停一个时钟周期，即保持pc_cur值不变。</p>
<img src="https://gcore.jsdelivr.net/gh/Haaazhng/images/img/202305251433278.png">

<h3 id="寄存器文件RF："><a href="#寄存器文件RF：" class="headerlink" title="寄存器文件RF："></a>寄存器文件RF：</h3><p>当某个寄存器的值同时被写入和被读取时，为了使读取到正确的寄存器值，需要修改RF模块为Write First工作模式。我们添加一个always@(*)组合逻辑，使读取的值跳过寄存器而直接从写入值wd处接收值，即直接令rd&#x3D;wd。我们知道，当目标寄存器是x0而正在写入的值不为0时，并不会改变x0的值。但如果此时我们按照上面的策略，会给rd赋一个错误的值，所以我们再加上一个条件判断：wa!&#x3D;0。</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token important">always@</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token keyword">begin</span>     <span class="token comment">//Write First实现</span>
    <span class="token function">if</span><span class="token punctuation">(</span>we<span class="token operator">==</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> wa<span class="token operator">!=</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> wa<span class="token operator">==</span>ra0<span class="token punctuation">)</span>
        rd0 <span class="token operator">=</span> wd<span class="token punctuation">;</span>
    <span class="token keyword">else</span> rd0 <span class="token operator">=</span> Regfile<span class="token punctuation">[</span>ra0<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">if</span><span class="token punctuation">(</span>we<span class="token operator">==</span><span class="token number">1</span> <span class="token operator">&amp;&amp;</span> wa<span class="token operator">!=</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> wa<span class="token operator">==</span>ra1<span class="token punctuation">)</span>
        rd1 <span class="token operator">=</span> wd<span class="token punctuation">;</span>
    <span class="token keyword">else</span> rd1 <span class="token operator">=</span> Regfile<span class="token punctuation">[</span>ra1<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="段间寄存器SEG-REG："><a href="#段间寄存器SEG-REG：" class="headerlink" title="段间寄存器SEG_REG："></a>段间寄存器SEG_REG：</h3><p>out信号的值取决于控制信号flush和stall。当flush有效时，所有out信号等于0；否则当stall信号有效时，out信号的值都保持不变；若stall和flush信号都无效（为0），则每个out信号的值等于对应的in信号，这也是一般情况下的结果，前两种情况是对冒险的处理。</p>
<img src="https://gcore.jsdelivr.net/gh/Haaazhng/images/img/202305251455037.png">

<h3 id="冒险处理Hazard："><a href="#冒险处理Hazard：" class="headerlink" title="冒险处理Hazard："></a>冒险处理Hazard：</h3><img src="https://gcore.jsdelivr.net/gh/Haaazhng/images/img/202305251454029.png">

<p><strong>结构冒险：</strong>由于我们采用哈佛结构，即指令存储器和数据存储器分开，所以不存在结构冒险。<br><strong>数据冒险：</strong>当MEM&#x2F;WB段正在执行的指令会向某寄存器写入结果（此时还未写入），但EX阶段的指令又需要该寄存器的值作为源操作数时，该指令在ID阶段从register file中读取的原始值就已经“过时”，这就是数据冒险。要得到正确的结果，则需要使用更新的源操作数，解决方法为将MEM&#x2F;WB段的即将写入的值前递给EX段作为更新的源操作数。根据rf_wd_sel的值有多个可能前递值：alu_ans，pc_add4，从数据存储器中读取的值，imm。对于WB段值的前递直接选择rf_wd_wb即可，因为这就是已经经过选择器的即将写入寄存器的值，但如果是MEM段值的前递呢？此时要写入的值还未经过选择器选择。但我们可以由rf_wd_sel_mem这个选择信号来帮助我们选择。对于选择alu_ans_mem，pc_add4_mem，imm_mem这三种情况的处理是容易的，但如果是数据存储器读取值呢？我们会发现在MEM段无法前递，必须到达WB段才能前递。所以我们必须要用一个stall信号，使IF，ID，EX段暂停一个时钟周期，并用flush_mem信号使MEM段清空。在下一个时钟周期MEM段的指令会执行到WB段，这时就能检测到前递了。<br>以下为rd0的非数据存储器读取结果前递的数据冒险处理，rd1同rd0。</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token comment">// rd0数据冒险检测</span>
        <span class="token comment">// MEM段前递，非数据存储器读取结果</span>
        <span class="token function">if</span><span class="token punctuation">(</span>rf_we_mem <span class="token operator">&amp;&amp;</span> rf_re0_ex <span class="token operator">&amp;&amp;</span> rf_wa_mem<span class="token operator">==</span>rf_ra0_ex <span class="token operator">&amp;&amp;</span> rf_wd_sel_mem<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token keyword">begin</span>
            rf_rd0_fe<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            rf_rd0_fd<span class="token operator">=</span>alu_ans_mem<span class="token punctuation">;</span>
        <span class="token keyword">end</span>
        <span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>rf_we_mem <span class="token operator">&amp;&amp;</span> rf_re0_ex <span class="token operator">&amp;&amp;</span> rf_wa_mem<span class="token operator">==</span>rf_ra0_ex <span class="token operator">&amp;&amp;</span> rf_wd_sel_mem<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">begin</span>
            rf_rd0_fe<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            rf_rd0_fd<span class="token operator">=</span>pc_add4_mem<span class="token punctuation">;</span>
        <span class="token keyword">end</span>
        <span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>rf_we_mem <span class="token operator">&amp;&amp;</span> rf_re0_ex <span class="token operator">&amp;&amp;</span> rf_wa_mem<span class="token operator">==</span>rf_ra0_ex <span class="token operator">&amp;&amp;</span> rf_wd_sel_mem<span class="token operator">==</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token keyword">begin</span>
            rf_rd0_fe<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            rf_rd0_fd<span class="token operator">=</span>imm_mem<span class="token punctuation">;</span>
        <span class="token keyword">end</span>
        <span class="token comment">// WB段前递</span>
        <span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>rf_we_wb <span class="token operator">&amp;&amp;</span> rf_re0_ex <span class="token operator">&amp;&amp;</span> rf_wa_wb<span class="token operator">==</span>rf_ra0_ex <span class="token punctuation">)</span><span class="token keyword">begin</span>
            rf_rd0_fe<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            rf_rd0_fd<span class="token operator">=</span>rf_wd_wb<span class="token punctuation">;</span>
        <span class="token keyword">end</span>
        <span class="token comment">// 不选择前递</span>
        <span class="token keyword">else</span> <span class="token keyword">begin</span>
            rf_rd0_fe<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            rf_rd0_fd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>MEM段需要前递数据存储器读取结果的处理</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token comment">// MEM段检测到要前递数据存储器读取结果</span>
<span class="token function">if</span><span class="token punctuation">(</span>rf_we_mem <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>rf_re1_ex <span class="token operator">&amp;&amp;</span> rf_wa_mem<span class="token operator">==</span>rf_ra1_ex<span class="token punctuation">)</span><span class="token operator">||</span><span class="token punctuation">(</span>rf_re0_ex <span class="token operator">&amp;&amp;</span> rf_wa_mem<span class="token operator">==</span>rf_ra0_ex<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rf_wd_sel_mem<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">begin</span>
    stall_if<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    stall_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    stall_ex<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    flush_mem<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>
<span class="token keyword">else</span> <span class="token keyword">begin</span>
    stall_if<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    stall_id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    stall_ex<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    flush_mem<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>控制冒险：</strong>对于分支跳转指令beq，blt，jalr，它们在EX阶段计算出跳转地址。如果预测失败，则需要在下一个时钟周期清空IF&#x2F;ID，ID&#x2F;EX段间寄存器，我们分别将这两个段间寄存器的控制信号flush_id，flush_ex置位1。对于控制提前到ID阶段的jal指令的冒险处理在后面讨论。</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token function">if</span><span class="token punctuation">(</span>pc_sel_ex<span class="token operator">==</span><span class="token number">1</span> <span class="token operator">||</span> pc_sel_ex<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token keyword">begin</span>       <span class="token comment">//EX阶段的jalr和branch指令跳转</span>
    flush_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    flush_ex<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>
<span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>pc_sel_ex<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> jal_id<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token keyword">begin</span>       <span class="token comment">// jal指令提前到ID阶段增加的冒险检测</span>
    flush_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
    flush_ex<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">end</span>
<span class="token keyword">else</span> <span class="token keyword">begin</span>
    flush_id<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    flush_ex<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h3 id="将控制提前到ID阶段的jal指令的处理："><a href="#将控制提前到ID阶段的jal指令的处理：" class="headerlink" title="将控制提前到ID阶段的jal指令的处理："></a>将控制提前到ID阶段的jal指令的处理：</h3><p><strong>注意</strong>：此做法会对开头给出的数据通路作出小的改变，主要体现在：pc_next的选择由四选一选择器改为了NPC_SEL模块，冒险模块增加了将jal指令提前后，与EX段的分支跳转指令产生的控制冒险的处理。</p>
<p>你也可以选择不将jal指令的控制提前，只需要按照原数据通路例化模块和连线。</p>
<p>jal指令的跳转地址等于pc+imm，所以我们在ID段添加一个加法器得到jal跳转地址pc_jal_id。我们知道，对于EX段产生的控制跳转预测失败时，需要清空IF&#x2F;ID和ID&#x2F;EX段间寄存器，那如果是在ID段控制跳转的jal指令呢？我们只需要清空IF&#x2F;ID段间寄存器，该冒险在Hazard模块中完成，Hazard模块需添加jal_id端口输入。<br>jal的跳转控制信号jal_id由ctrl产生，但是当jal_id有效时不可不假思索的直接跳转，因为可能会有控制冒险：此时EX段是一个jalr指令或预测失败branch指令。由于这个指令先于jal指令，故也应该优先执行EX的分支跳转指令。只有当EX不是分支跳转指令或是预测成功的分支跳转指令时，才可执行ID段的jal控制跳转指令。我们创建模块NPC_SEL模块处理该冒险，具体如下：</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">module</span> <span class="token function">NPC_SEL</span><span class="token punctuation">(</span>
        <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> pc_add4_if<span class="token punctuation">,</span>
        <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> pc_jalr_ex<span class="token punctuation">,</span>
        <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> alu_ans_ex<span class="token punctuation">,</span>
        <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> pc_jal_id<span class="token punctuation">,</span>
        <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> pc_sel_ex<span class="token punctuation">,</span>
        <span class="token keyword">input</span> jal_id<span class="token punctuation">,</span>
        <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> pc_next
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token important">always @</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>
        <span class="token function">if</span><span class="token punctuation">(</span>pc_sel_ex<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>                <span class="token comment">//EX段的分支跳转优先</span>
            pc_next<span class="token operator">=</span>pc_jalr_ex<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>pc_sel_ex<span class="token operator">==</span><span class="token number">2</span><span class="token punctuation">)</span>
            pc_next<span class="token operator">=</span>alu_ans_ex<span class="token punctuation">;</span>
        <span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>pc_sel_ex<span class="token operator">==</span><span class="token number">0</span> <span class="token operator">&amp;&amp;</span> jal_id<span class="token operator">==</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment">//提前到ID段的jal跳转</span>
            pc_next<span class="token operator">=</span>pc_jal_id<span class="token punctuation">;</span>
        <span class="token keyword">else</span> pc_next<span class="token operator">=</span>pc_add4_if<span class="token punctuation">;</span>            <span class="token comment">//不跳转</span>
    <span class="token keyword">end</span>
<span class="token keyword">endmodule</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>为了使执行到EX阶段的jal不二次跳转，我们在Encoder例化时给输入端口jal赋0即可。</p>
<h2 id="性能比较"><a href="#性能比较" class="headerlink" title="性能比较"></a>性能比较</h2><p>若IF段延迟为300ps，ID段延迟200ps，EX段延迟150ps，MEM段延迟350ps，WB段延迟250ps，那么流水线CPU的最短时钟周期为350ps，平均条指令用时一个时钟周期350ps，而单周期CPU的最短周期为1250ps，每条指令用时一个时钟周期1250ps。流水线CPU比单周期CPU耗时少72%，可见流水线CPU大大提高了CPU的性能。</p>
<h2 id="7-10更新"><a href="#7-10更新" class="headerlink" title="7.10更新"></a>7.10更新</h2><p>实现了RV-32I 所有非系统指令和RV-32M乘除法指令。<br>除以上十条指令外，还包括<br>算数与逻辑指令：sll、slli、srl、srli、sra、srai、sub、xor、xori、or、ori、and、andi<br>分支与条件指令：bne、bge、bltu、bgeu、slt、slti、slti、sltiu<br>访存指令6：lb、lh、lbu、lhu、sb、sh<br>乘除法指令：mul、mulh、mulhu、mulhsu、div、divu、rem、remu</p>
<h3 id="实现思路"><a href="#实现思路" class="headerlink" title="实现思路"></a>实现思路</h3><p><strong>算术、逻辑与条件指令</strong><br>这些指令的数据通路基本一致，大同小异，实现较为简单，主要区别在于alu_func选择信号不同，并且都是将ALU计算结果存入寄存器。需要添加算术右移操作以处理sra和srai。</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token function">case</span><span class="token punctuation">(</span>func<span class="token punctuation">)</span>
        <span class="token number">4'b0000</span><span class="token punctuation">:</span>y<span class="token operator">=</span>a<span class="token operator">+</span>b<span class="token punctuation">;</span>
        <span class="token number">4'b0001</span><span class="token punctuation">:</span>y<span class="token operator">=</span>a<span class="token operator">-</span>b<span class="token punctuation">;</span>
        <span class="token number">4'b0010</span><span class="token punctuation">:</span>y<span class="token operator">=</span><span class="token punctuation">(</span>a<span class="token operator">==</span>b<span class="token operator">?</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token number">4'b0011</span><span class="token punctuation">:</span>y<span class="token operator">=</span><span class="token punctuation">(</span>a<span class="token operator">&lt;</span>b<span class="token operator">?</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token number">4'b0100</span><span class="token punctuation">:</span>y<span class="token operator">=</span><span class="token punctuation">(</span><span class="token kernel-function property">$signed</span> <span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token kernel-function property">$signed</span> <span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token number">4'b0101</span><span class="token punctuation">:</span>y<span class="token operator">=</span>a<span class="token operator">&amp;</span>b<span class="token punctuation">;</span>
        <span class="token number">4'b0110</span><span class="token punctuation">:</span>y<span class="token operator">=</span>a<span class="token operator">|</span>b<span class="token punctuation">;</span>
        <span class="token number">4'b0111</span><span class="token punctuation">:</span>y<span class="token operator">=</span>a<span class="token operator">^</span>b<span class="token punctuation">;</span>
        <span class="token number">4'b1000</span><span class="token punctuation">:</span>y<span class="token operator">=</span>a<span class="token operator">>></span>b<span class="token punctuation">;</span>
        <span class="token number">4'b1001</span><span class="token punctuation">:</span>y<span class="token operator">=</span>a<span class="token operator">&lt;&lt;</span>b<span class="token punctuation">;</span>
        <span class="token number">4'b1010</span><span class="token punctuation">:</span>y<span class="token operator">=</span><span class="token kernel-function property">$signed</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token kernel-function property">$signed</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">>>></span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>y<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">endcase</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>然后在CTRL译码模块中依据指令类型选择alu_func控制信号即可。</p>
<p><strong>分支指令</strong></p>
<p>分支指令新增了bne、bge、bltu、bgeu四条，数据通路与原来流水线中的beq、blt数据通路一致，重点在于修改Branch模块，添加这四种信号的处理：</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">case</span> <span class="token punctuation">(</span>br_type<span class="token punctuation">)</span>
            <span class="token number">1</span><span class="token punctuation">:</span><span class="token keyword">begin</span>     <span class="token comment">//blt</span>
                <span class="token function">if</span><span class="token punctuation">(</span><span class="token kernel-function property">$signed</span><span class="token punctuation">(</span>op1<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token kernel-function property">$signed</span><span class="token punctuation">(</span>op2<span class="token punctuation">)</span><span class="token punctuation">)</span> br<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> br<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span> 
            <span class="token number">2</span><span class="token punctuation">:</span><span class="token keyword">begin</span>     <span class="token comment">//beq</span>
                <span class="token function">if</span><span class="token punctuation">(</span>op1 <span class="token operator">==</span> op2<span class="token punctuation">)</span> br<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> br<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token number">3</span><span class="token punctuation">:</span><span class="token keyword">begin</span>     <span class="token comment">//bne</span>
                <span class="token function">if</span><span class="token punctuation">(</span>op1 <span class="token operator">!=</span> op2<span class="token punctuation">)</span> br<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> br<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span> 
            <span class="token number">4</span><span class="token punctuation">:</span><span class="token keyword">begin</span>     <span class="token comment">//bge</span>
                <span class="token function">if</span><span class="token punctuation">(</span><span class="token kernel-function property">$signed</span><span class="token punctuation">(</span>op1<span class="token punctuation">)</span> <span class="token operator">>=</span> <span class="token kernel-function property">$signed</span><span class="token punctuation">(</span>op2<span class="token punctuation">)</span><span class="token punctuation">)</span> br<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> br<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span> 
            <span class="token number">5</span><span class="token punctuation">:</span><span class="token keyword">begin</span>     <span class="token comment">//bltu</span>
                <span class="token function">if</span><span class="token punctuation">(</span>op1 <span class="token operator">&lt;</span> op2<span class="token punctuation">)</span> br<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> br<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span> 
            <span class="token number">6</span><span class="token punctuation">:</span><span class="token keyword">begin</span>     <span class="token comment">//bgeu</span>
                <span class="token function">if</span><span class="token punctuation">(</span>op1 <span class="token operator">>=</span> op2<span class="token punctuation">)</span> br<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> br<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span> 
            <span class="token keyword">default</span><span class="token punctuation">:</span><span class="token keyword">begin</span>
                br<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span> 
        <span class="token keyword">endcase</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>访存指令</strong></p>
<p>增加了六条访存指令lb、lbu、lh、lhu、sb、sh。对于原来的流水线CPU实现，由于只实现lw和sw，为了实现的简便，我们例化的数据存储器IP核的数据宽度设置为了4bytes，因为lw和sw都是对连续四个字节的访问。但不同于lw和sw，这六条指令中lb，lbu，sb指令只涉及到一个字节的访问，而另外三条则只涉及到两个字节的访问。此时如果仍然以原存储器进行设计，不论我们想访问的是几个字节，都只能以四个字节为单位进行。所以很容易想到的一种实现方式是，如果要读取一个字节（lb，lbu），则将整个4字节读取出来，根据地址低2位选择处理结果，读取两个字节时（lh、lhu）类推。但如果是存储呢（sb、sh）？因为必须以四字节为一个单位进行存储，也按这种实现方式存储务必会覆盖另一些地址中的原数据，这种情况我们当然是不愿意看到的。所以我们又会自然而然的想到把整个四字节先读出来，再根据地址低2位更改相应byte而不动其他数据，然后再存进去，这样可行？理论上是可行的，但在实际情况中，由于访存指令需要大量时钟周期，如果采用上面的二次读取写入的的做法，会使CPU性能“雪上加霜”，大大提高CPI，这就得不偿失了。所以，我采用了另一种方法，那就是将原来的一个数据宽度为4Bytes的数据存储器，拆分为四个数据宽度为1Byte的数据存储器dm1，dm2，dm3，dm4。对于每一个dm_addr[9:2]，这四个数据存储器中对应地址的数据共4Bytes共同组成一个字。当访问一个字节时，再根据dm_addr[1:0]对相应的某一个或两个或四个dm进行访问。这样就很好的解决了前面讨论的问题。具体代码实现：</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token important">always @</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>
        we1<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        we2<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        we3<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        we4<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        wd<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        dm_dout<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> <span class="token punctuation">(</span>access_type<span class="token punctuation">)</span>
            <span class="token number">0</span><span class="token punctuation">:</span><span class="token keyword">begin</span>     <span class="token comment">//lb指令</span>
                <span class="token function">case</span><span class="token punctuation">(</span>dm_addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                <span class="token number">0</span><span class="token punctuation">:</span>dm_dout<span class="token operator">=&#123;&#123;</span><span class="token number">24</span><span class="token operator">&#123;</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span><span class="token operator">&#125;&#125;</span><span class="token punctuation">,</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
                <span class="token number">1</span><span class="token punctuation">:</span>dm_dout<span class="token operator">=&#123;&#123;</span><span class="token number">24</span><span class="token operator">&#123;</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token operator">&#125;&#125;</span><span class="token punctuation">,</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
                <span class="token number">2</span><span class="token punctuation">:</span>dm_dout<span class="token operator">=&#123;&#123;</span><span class="token number">24</span><span class="token operator">&#123;</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span><span class="token operator">&#125;&#125;</span><span class="token punctuation">,</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
                <span class="token keyword">default</span><span class="token punctuation">:</span>dm_dout<span class="token operator">=&#123;&#123;</span><span class="token number">24</span><span class="token operator">&#123;</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token operator">&#125;&#125;</span><span class="token punctuation">,</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
                <span class="token keyword">endcase</span>
            <span class="token keyword">end</span>
            <span class="token number">1</span><span class="token punctuation">:</span><span class="token keyword">begin</span>     <span class="token comment">//lh指令，偶数字节对齐</span>
                <span class="token function">if</span><span class="token punctuation">(</span>dm_addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    dm_dout<span class="token operator">=&#123;&#123;</span><span class="token number">16</span><span class="token operator">&#123;</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token operator">&#125;&#125;</span><span class="token punctuation">,</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> dm_dout<span class="token operator">=&#123;&#123;</span><span class="token number">16</span><span class="token operator">&#123;</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span><span class="token operator">&#125;&#125;</span><span class="token punctuation">,</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token number">2</span><span class="token punctuation">:</span><span class="token keyword">begin</span>     <span class="token comment">//lbu指令</span>
                <span class="token keyword">case</span> <span class="token punctuation">(</span>dm_addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token number">0</span><span class="token punctuation">:</span> dm_dout<span class="token operator">=&#123;</span><span class="token number">24'b0</span><span class="token punctuation">,</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
                    <span class="token number">1</span><span class="token punctuation">:</span> dm_dout<span class="token operator">=&#123;</span><span class="token number">24'b0</span><span class="token punctuation">,</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
                    <span class="token number">2</span><span class="token punctuation">:</span> dm_dout<span class="token operator">=&#123;</span><span class="token number">24'b0</span><span class="token punctuation">,</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
                    <span class="token keyword">default</span><span class="token punctuation">:</span>  dm_dout<span class="token operator">=&#123;</span><span class="token number">24'b0</span><span class="token punctuation">,</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
                <span class="token keyword">endcase</span>
            <span class="token keyword">end</span>
            <span class="token number">3</span><span class="token punctuation">:</span><span class="token keyword">begin</span>         <span class="token comment">//lhu指令，偶数字节对齐</span>
                <span class="token function">if</span><span class="token punctuation">(</span>dm_addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    dm_dout<span class="token operator">=&#123;</span><span class="token number">16'b0</span><span class="token punctuation">,</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
                <span class="token keyword">else</span> dm_dout<span class="token operator">=&#123;</span><span class="token number">16'b0</span><span class="token punctuation">,</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token number">4</span><span class="token punctuation">:</span> dm_dout<span class="token operator">=</span>dm_out_tmp<span class="token punctuation">;</span>      <span class="token comment">//lw指令</span>
            <span class="token number">5</span><span class="token punctuation">:</span><span class="token keyword">begin</span>         <span class="token comment">//sb指令</span>
                <span class="token keyword">case</span> <span class="token punctuation">(</span>dm_addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                    <span class="token number">0</span><span class="token punctuation">:</span><span class="token keyword">begin</span>
                        we1<span class="token operator">=</span>dm_we<span class="token punctuation">;</span>        <span class="token comment">//Not MMIO</span>
                        wd<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>dm_din<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">end</span>
                    <span class="token number">1</span><span class="token punctuation">:</span><span class="token keyword">begin</span>
                        we2<span class="token operator">=</span>dm_we<span class="token punctuation">;</span>
                        wd<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token operator">=</span>dm_din<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">end</span>
                    <span class="token number">2</span><span class="token punctuation">:</span><span class="token keyword">begin</span>
                        we3<span class="token operator">=</span>dm_we<span class="token punctuation">;</span>
                        wd<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span>dm_din<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">end</span>
                    <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>
                        we4<span class="token operator">=</span>dm_we<span class="token punctuation">;</span>
                        wd<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token operator">=</span>dm_din<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                    <span class="token keyword">end</span>
                <span class="token keyword">endcase</span>
            <span class="token keyword">end</span> 
            <span class="token number">6</span><span class="token punctuation">:</span><span class="token keyword">begin</span>     <span class="token comment">//sh指令地址偶数字节对齐</span>
                <span class="token function">if</span><span class="token punctuation">(</span>dm_addr<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token keyword">begin</span>
                    we3<span class="token operator">=</span>dm_we<span class="token punctuation">;</span>
                    we4<span class="token operator">=</span>dm_we<span class="token punctuation">;</span>
                    wd<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token operator">=</span>dm_din<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">end</span>
                <span class="token keyword">else</span> <span class="token keyword">begin</span>
                    we1<span class="token operator">=</span>dm_we<span class="token punctuation">;</span>
                    we2<span class="token operator">=</span>dm_we<span class="token punctuation">;</span>
                    wd<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=</span>dm_din<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                <span class="token keyword">end</span>
            <span class="token keyword">end</span> 
            <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>      <span class="token comment">//sw指令</span>
                we1<span class="token operator">=</span>dm_we<span class="token punctuation">;</span>
                we2<span class="token operator">=</span>dm_we<span class="token punctuation">;</span>
                we3<span class="token operator">=</span>dm_we<span class="token punctuation">;</span>
                we4<span class="token operator">=</span>dm_we<span class="token punctuation">;</span>
                wd<span class="token operator">=</span>dm_din<span class="token punctuation">;</span>
            <span class="token keyword">end</span>
        <span class="token keyword">endcase</span>
    <span class="token keyword">end</span>

    ROM inst_mem <span class="token punctuation">(</span>
        <span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span>im_addr<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// input wire [9 : 0] a</span>
        <span class="token punctuation">.</span><span class="token function">spo</span><span class="token punctuation">(</span>im_dout<span class="token punctuation">)</span>  <span class="token comment">// output wire [31 : 0] spo</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    DPRAM1 dm1 <span class="token punctuation">(</span>
        <span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span>dm_addr<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment">// input wire [7 : 0] a</span>
        <span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>wd<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">// input wire [7 : 0] d</span>
        <span class="token punctuation">.</span><span class="token function">dpra</span><span class="token punctuation">(</span>mem_check_addr<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// input wire [7 : 0] dpra</span>
        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// input wire clk</span>
        <span class="token punctuation">.</span><span class="token function">we</span><span class="token punctuation">(</span>we1<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// input wire we</span>
        <span class="token punctuation">.</span><span class="token function">spo</span><span class="token punctuation">(</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">// output wire [7 : 0] spo</span>
        <span class="token punctuation">.</span><span class="token function">dpo</span><span class="token punctuation">(</span>mem_check_data<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment">// output wire [7 : 0] dpo</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    DPRAM1 dm2 <span class="token punctuation">(</span>
        <span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span>dm_addr<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment">// input wire [7 : 0] a</span>
        <span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>wd<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">// input wire [7 : 0] d</span>
        <span class="token punctuation">.</span><span class="token function">dpra</span><span class="token punctuation">(</span>mem_check_addr<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// input wire [7 : 0] dpra</span>
        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// input wire clk</span>
        <span class="token punctuation">.</span><span class="token function">we</span><span class="token punctuation">(</span>we2<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// input wire we</span>
        <span class="token punctuation">.</span><span class="token function">spo</span><span class="token punctuation">(</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">// output wire [7 : 0] spo</span>
        <span class="token punctuation">.</span><span class="token function">dpo</span><span class="token punctuation">(</span>mem_check_data<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment">// output wire [7 : 0] dpo</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    DPRAM1 dm3 <span class="token punctuation">(</span>
        <span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span>dm_addr<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment">// input wire [7 : 0] a</span>
        <span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>wd<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">// input wire [7 : 0] d</span>
        <span class="token punctuation">.</span><span class="token function">dpra</span><span class="token punctuation">(</span>mem_check_addr<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// input wire [7 : 0] dpra</span>
        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// input wire clk</span>
        <span class="token punctuation">.</span><span class="token function">we</span><span class="token punctuation">(</span>we3<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// input wire we</span>
        <span class="token punctuation">.</span><span class="token function">spo</span><span class="token punctuation">(</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">// output wire [7 : 0] spo</span>
        <span class="token punctuation">.</span><span class="token function">dpo</span><span class="token punctuation">(</span>mem_check_data<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment">// output wire [7 : 0] dpo</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    DPRAM1 dm4 <span class="token punctuation">(</span>
        <span class="token punctuation">.</span><span class="token function">a</span><span class="token punctuation">(</span>dm_addr<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token comment">// input wire [7 : 0] a</span>
        <span class="token punctuation">.</span><span class="token function">d</span><span class="token punctuation">(</span>wd<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>         <span class="token comment">// input wire [7 : 0] d</span>
        <span class="token punctuation">.</span><span class="token function">dpra</span><span class="token punctuation">(</span>mem_check_addr<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// input wire [7 : 0] dpra</span>
        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token comment">// input wire clk</span>
        <span class="token punctuation">.</span><span class="token function">we</span><span class="token punctuation">(</span>we4<span class="token punctuation">)</span><span class="token punctuation">,</span>      <span class="token comment">// input wire we</span>
        <span class="token punctuation">.</span><span class="token function">spo</span><span class="token punctuation">(</span>dm_out_tmp<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>     <span class="token comment">// output wire [7 : 0] spo</span>
        <span class="token punctuation">.</span><span class="token function">dpo</span><span class="token punctuation">(</span>mem_check_data<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token comment">// output wire [7 : 0] dpo</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>Lb，lbu，lh，lhu和lw一样存在需要在MEM段前递的冒险，处理也和lw指令一样，将IF、ID、EX停顿。这样虽然在下一个时钟周期能够检测到wb段Load指令的前递了，但假如原来同时需要MEM段Load指令的前递和WB段的前递，这种处理还是会得到错误的值，因为它将原WB段的前递冲刷掉了。所以我们在WB段后添加一个寄存器寄存上个时钟周期WB跟前递相关的值，然后在Hazard模块中增加对上述冒险的处理，选择该寄存器的值作为前递即可。</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">module</span> <span class="token function">Wd_reg_wb</span><span class="token punctuation">(</span>
    <span class="token keyword">input</span> clk<span class="token punctuation">,</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> rf_wd_wb<span class="token punctuation">,</span>
    <span class="token keyword">input</span> rf_we_wb<span class="token punctuation">,</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> rf_wa_wb<span class="token punctuation">,</span>
    <span class="token keyword">input</span> stall_reg<span class="token punctuation">,</span>
    <span class="token keyword">output</span> <span class="token keyword">reg</span> rf_we_reg<span class="token punctuation">,</span>
    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> rf_wa_reg<span class="token punctuation">,</span>
    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> wd_wb_fd_reg
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token important">always @</span><span class="token punctuation">(</span><span class="token keyword">posedge</span> clk<span class="token punctuation">)</span> <span class="token keyword">begin</span>
        <span class="token function">if</span><span class="token punctuation">(</span>stall_reg<span class="token punctuation">)</span><span class="token keyword">begin</span>
            wd_wb_fd_reg<span class="token operator">&lt;=</span>wd_wb_fd_reg<span class="token punctuation">;</span>
            rf_we_reg<span class="token operator">&lt;=</span>rf_we_reg<span class="token punctuation">;</span>
            rf_wa_reg<span class="token operator">&lt;=</span>rf_wa_reg<span class="token punctuation">;</span>
        <span class="token keyword">end</span>
        <span class="token keyword">else</span> <span class="token keyword">begin</span>
            wd_wb_fd_reg<span class="token operator">&lt;=</span>rf_wd_wb<span class="token punctuation">;</span>
            rf_we_reg<span class="token operator">&lt;=</span>rf_we_wb<span class="token punctuation">;</span>
            rf_wa_reg<span class="token operator">&lt;=</span>rf_wa_wb<span class="token punctuation">;</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span>
<span class="token keyword">endmodule</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>rf_we_reg <span class="token operator">&amp;&amp;</span> rf_re1_ex <span class="token operator">&amp;&amp;</span> rf_wa_reg<span class="token operator">==</span>rf_ra1_ex<span class="token punctuation">)</span><span class="token keyword">begin</span>    <span class="token comment">//冲刷掉的WB段的原前递</span>
            rf_rd1_fe<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
            rf_rd1_fd<span class="token operator">=</span>wd_wb_fd_reg<span class="token punctuation">;</span>
        <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>

<p><strong>乘法器设计</strong></p>
<p>乘法器可以用组合电路来完成，但如果在一个时钟周期内完成，就可能带来高延迟，所以我们将其分为两个部分，用两级流水线完成计算：在EX段完成2位Booth编码和伪华莱士树计算，得出最后两个数，在MEM段将这两个64bit位宽的数据相加得到乘法结果。<br>Booth编码：</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">module</span> <span class="token function">Booth_Encoder</span><span class="token punctuation">(</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> y<span class="token punctuation">,</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> x<span class="token punctuation">,</span>
    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> res 
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token important">always @</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>
        <span class="token keyword">case</span> <span class="token punctuation">(</span>y<span class="token punctuation">)</span>
            <span class="token number">1</span><span class="token punctuation">:</span><span class="token keyword">begin</span>
                res<span class="token operator">=</span>x<span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>
                res<span class="token operator">=</span>x<span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token number">3</span><span class="token punctuation">:</span><span class="token keyword">begin</span>
                res<span class="token operator">=</span>x<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token number">4</span><span class="token punctuation">:</span><span class="token keyword">begin</span>
                res<span class="token operator">=</span><span class="token punctuation">(</span><span class="token operator">~</span>x<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token number">5</span><span class="token punctuation">:</span><span class="token keyword">begin</span>
                res<span class="token operator">=~</span>x<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token number">6</span><span class="token punctuation">:</span><span class="token keyword">begin</span>
                res<span class="token operator">=~</span>x<span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
            <span class="token keyword">default</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>
                res<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span>
            <span class="token keyword">end</span>
        <span class="token keyword">endcase</span>
    <span class="token keyword">end</span>
<span class="token keyword">endmodule</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>保留进位加法器：</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">module</span> <span class="token function">CSA</span><span class="token punctuation">(</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> a<span class="token punctuation">,</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> b<span class="token punctuation">,</span>
    <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> c<span class="token punctuation">,</span>
    <span class="token keyword">output</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> s<span class="token punctuation">,</span>
    <span class="token keyword">output</span> <span class="token punctuation">[</span><span class="token number">63</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cout
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">assign</span> s<span class="token operator">=</span>a<span class="token operator">^</span>b<span class="token operator">^</span>c<span class="token punctuation">;</span>
    <span class="token keyword">assign</span> cout<span class="token operator">=</span><span class="token punctuation">(</span><span class="token punctuation">(</span>a<span class="token operator">&amp;</span>b<span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">~</span>a<span class="token operator">&amp;</span>b<span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">~</span>b<span class="token operator">&amp;</span>a<span class="token operator">&amp;</span>c<span class="token punctuation">)</span><span class="token operator">|</span><span class="token punctuation">(</span><span class="token operator">~</span>c<span class="token operator">&amp;</span>a<span class="token operator">&amp;</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">endmodule</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>在伪华莱士树模块中，例化17个Booth_Encoder模块将32个部分和装化为17个部分和，为什么不是16个？我们将32bit拓展为34bit，由于乘数可能是无符号数，这时如果第32位为1，则将第33、34置为0。这时根据这17个编码值构造6层的伪华莱士树，共例化15个保留进位加法器CSA，最后得到最后两个部分和，将这两个数传入MEM得出和，即为结果。在实现过程中我们看到，乘法指令需要再MEM段才能算出结果，类似Load指令的数据冒险，当EX段的指令需要正在MEM段的乘法指令的计算结果的前递时，需要将IF、ID、EX段停顿一个周期。当MEM段的乘法指令执行到WB段就能检测到前递了。</p>
<p><strong>移位除法器设计</strong><br>初始时，先根据除法指令类型（Div or Rem or Divu or Remu）以及被除数和除数的符号，记录计算结果的符号，在计算完毕时，再恢复符号。由于移位除法器不能组合化，需要多个时钟周期完成，故需要和流水线进行握手，在Hazard模块中完成。移位除法器计数器cnt初始化值为32，每个时钟周期减1，将cnt传入Hazard模块中，cnt！&#x3D;-1且判断EX段指令类型为除法时，将stall_if、stall_id、stall_ex、stall_mem、stall_wb都设置为1，整个流水线停顿等待除法计算完成。减为-1时说明计算完成，流水线正常执行。注意到每个除法指令固定执行34个周期，移位33次，当被除数较小时，可以将前导0去除，可以降低移位次数，从而降低停顿次数，提升CPU性能。我们使用对数器完成提前启动：</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token keyword">assign</span> minus<span class="token operator">=</span>rq<span class="token punctuation">[</span><span class="token number">64</span><span class="token punctuation">:</span><span class="token number">32</span><span class="token punctuation">]</span><span class="token operator">-&#123;</span><span class="token number">1'b0</span><span class="token punctuation">,</span>abs_divisor<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> oor<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">=|</span>abs_divident<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> oor<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">=|</span>d16<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> oor<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">=|</span>d8<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> oor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">=|</span>d4<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> d16<span class="token operator">=</span><span class="token punctuation">(</span>oor<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span><span class="token operator">?</span> abs_divident<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">:</span>abs_divident<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> d8<span class="token operator">=</span><span class="token punctuation">(</span>oor<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token operator">?</span> d16<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">8</span><span class="token punctuation">]</span><span class="token punctuation">:</span>d16<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> d4<span class="token operator">=</span><span class="token punctuation">(</span>oor<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token operator">?</span> d8<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">:</span>d8<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> d2<span class="token operator">=</span><span class="token punctuation">(</span>oor<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">?</span> d4<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">:</span>d4<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
<span class="token keyword">assign</span> add2<span class="token operator">=</span><span class="token punctuation">(</span>d2<span class="token operator">==</span><span class="token number">3</span><span class="token operator">?</span> <span class="token number">2</span><span class="token punctuation">:</span>d2<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> tmp<span class="token operator">=&#123;</span>oor<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1'b0</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
<span class="token keyword">assign</span> log<span class="token operator">=</span><span class="token punctuation">(</span>abs_divident<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span><span class="token operator">?</span> <span class="token number">32</span><span class="token punctuation">:</span><span class="token punctuation">(</span>tmp<span class="token operator">+</span>add2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">//log为提前启动取得的对数上整</span>

<span class="token keyword">assign</span> pre_divident<span class="token operator">=</span>abs_divident<span class="token operator">&lt;&lt;</span><span class="token punctuation">(</span><span class="token number">32</span><span class="token operator">-</span>log<span class="token punctuation">)</span><span class="token punctuation">;</span>     <span class="token comment">//将被除数先左移32-log位，去除前导0</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>并将计数器cnt初始化为取得的对数上整（log）。<br>除法器状态机实现：</p>
<pre class="line-numbers language-verilog" data-language="verilog"><code class="language-verilog"><span class="token important">always @</span><span class="token punctuation">(</span><span class="token keyword">posedge</span> clk<span class="token punctuation">)</span> <span class="token keyword">begin</span>
        cs<span class="token operator">&lt;=</span>ns<span class="token punctuation">;</span>
        <span class="token function">if</span><span class="token punctuation">(</span>ns<span class="token operator">==</span>Shift<span class="token punctuation">)</span>
            cnt_ns<span class="token operator">&lt;=</span>cnt<span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> cnt_ns<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token function">if</span><span class="token punctuation">(</span>minus<span class="token punctuation">[</span><span class="token number">32</span><span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> ns<span class="token operator">==</span>Shift<span class="token punctuation">)</span>       <span class="token comment">//余数与除数差小于0</span>
            rq_ns<span class="token operator">&lt;=</span>rq<span class="token operator">&lt;&lt;</span><span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">else</span> rq_ns<span class="token operator">&lt;=&#123;</span>minus<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>rq<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">1'b1</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
    <span class="token keyword">end</span>

    <span class="token important">always @</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>
        <span class="token function">if</span><span class="token punctuation">(</span>cnt<span class="token operator">!=</span><span class="token number">6'b111111</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>cal_ans_sel<span class="token operator">==</span><span class="token number">3</span><span class="token operator">||</span>cal_ans_sel<span class="token operator">==</span><span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> flush_mem<span class="token operator">==</span><span class="token number">0</span><span class="token punctuation">)</span> 
            ns<span class="token operator">=</span>Shift<span class="token punctuation">;</span> 
        <span class="token keyword">else</span> ns<span class="token operator">=</span>Init<span class="token punctuation">;</span>
    <span class="token keyword">end</span>

    <span class="token important">always @</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>
        <span class="token function">if</span><span class="token punctuation">(</span>cs<span class="token operator">==</span>Init<span class="token punctuation">)</span><span class="token keyword">begin</span>
            rq<span class="token operator">=&#123;</span><span class="token number">33'b0</span><span class="token punctuation">,</span>pre_divident<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&#125;</span><span class="token punctuation">;</span>
            cnt<span class="token operator">=</span>log<span class="token punctuation">;</span>
        <span class="token keyword">end</span>
        <span class="token keyword">else</span> <span class="token keyword">begin</span>
            rq<span class="token operator">=</span>rq_ns<span class="token punctuation">;</span>
            cnt<span class="token operator">=</span>cnt_ns<span class="token punctuation">;</span>
        <span class="token keyword">end</span>
    <span class="token keyword">end</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>一种存在的数据冒险是MEM段正在执行的乘法指令或Load指令，而EX段的除法指令需要MEM段的前递，通过前面的讨论我们知道这种情况需要在下一个周期将IF、ID、EX停顿，冲刷MEM，正常执行WB，但EX段的除法又需要将五个部分都停顿，这不就矛盾了？正确的处理方法是：优先执行前者，因为除法指令需要等待MEM段的乘法或Load执行到WB段才能得到正确的前递值，此时的EX段停顿，RQ寄存器还不能进行移位操作，所以下一状态仍然是Init。再过一个时钟周期，得到正确的前递了，EX段的除法器可以正常进行了。<br>还有一种冒险，跟上一个冒险的条件相同，但EX段的除法指令同时需要MEM段的乘法或Load指令结果前递，和WB段的前递。如下列指令</p>
<pre class="line-numbers language-risc-v" data-language="risc-v"><code class="language-risc-v">addi t4 x0 199
mul t3 t0 t1        # mul停顿冲刷t4前递的冒险检测验证
divu t2 t3 t4<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>在前面讨论的冒险处理的基础上，在下一个周期会同时得到WB段mul的前递，和寄存在WB后面的寄存器Wd_Reg_wb里的被冲刷的原WB数据addi的前递。看起来好像没什么问题，还是正确的得到了前递结果。但再过一个时钟周期呢？这时Wd_Reg_wb寄存器里的wd_wb_fd_reg寄存的值就由addi指令的值变成了mul的值，中途除法器的除数变了，所以也会的到一个错误结果。解决方法就是EX段除法器让五个流水线级停顿时，让Wd_Reg_wb寄存器也停顿，从而保证中途除法器源操作数不被篡改。</p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">dzhang</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://Haaazhng.github.io/2023/05/25/22463.html">https://Haaazhng.github.io/2023/05/25/22463.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">dzhang</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Verilog/">
                                    <span class="chip bg-color">Verilog</span>
                                </a>
                            
                                <a href="/tags/RISC-V/">
                                    <span class="chip bg-color">RISC-V</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    
        <style>
    .mvaline-card {
        margin: 1.5rem auto;
    }

    .mvaline-card .card-content {
        padding: 20px 20px 5px 20px;
    }
</style>

<div class="card mvaline-card" data-aos="fade-up">
    <div class="comment_headling" style="font-size: 20px; font-weight: 700; position: relative; padding-left: 20px; top: 15px; padding-bottom: 5px;">
        <i class="fas fa-comments fa-fw" aria-hidden="true"></i>
        <span>评论</span>
    </div>
    <div id="mvcomments" class="card-content" style="display: grid">
    </div>
</div>

<script src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/minivaline/MiniValine.js"></script>
<script>
    new MiniValine({
        el: '#mvcomments',
        appId: 'nEd3w4eTJdzsWcZNiMQvZBDW-gzGzoHsz',
        appKey: 'Uzi1DBBMXIb70ar3DzIVjA3s',
        mode: 'DesertsP',
        placeholder: 'Leave a Comment',
        pathname: window.location.pathname,
        lang: '',
        adminEmailMd5: 'de8a7aa53d07e6b6bceb45c64027763d',
        tagMeta: ["管理员", "小伙伴", "访客"],
        master: ["de8a7aa53d07e6b6bceb45c64027763d"],
        friends: ["b5bd5d836c7a0091aa8473e79ed4c25e", "adb7d1cd192658a55c0ad22a3309cecf", "3ce1e6c77b4910f1871106cb30dc62b0", "cfce8dc43725cc14ffcd9fb4892d5bfc"],
        math: true,
        md: true,
        enableQQ: false,
        NoRecordIP: false,
        visitor: true,
        maxNest: 6,
        pageSize: 6,
        serverURLs: '',
        emoticonUrl: ["https://cdn.jsdelivr.net/npm/alus@latest", "https://cdn.jsdelivr.net/gh/MiniValine/qq@latest", "https://cdn.jsdelivr.net/gh/MiniValine/Bilibilis@latest", "https://cdn.jsdelivr.net/gh/MiniValine/tieba@latest", "https://cdn.jsdelivr.net/gh/MiniValine/twemoji@latest", "https://cdn.jsdelivr.net/gh/MiniValine/weibo@latest"],
    });
</script>

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2023/05/25/22463.html">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/medias/featureimages/15.jpg" class="responsive-img" alt="流水线CPU设计">
                        
                        <span class="card-title">流水线CPU设计</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            在单周期CPU的基础上，将其改进为五级流水线CPU
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-05-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/COD/" class="post-category">
                                    COD
                                </a>
                            
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Verilog/">
                        <span class="chip bg-color">Verilog</span>
                    </a>
                    
                    <a href="/tags/RISC-V/">
                        <span class="chip bg-color">RISC-V</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2023/05/25/22462.html">
                    <div class="card-image">
                        
                        
                        <img src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/medias/featureimages/1.jpg" class="responsive-img" alt="单周期CPU设计">
                        
                        <span class="card-title">单周期CPU设计</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            用Verilog设计一个简易的单周期CPU，使其能运行RISC-V指令集架构下的21种指令
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-05-25
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/COD/" class="post-category">
                                    COD
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Verilog/">
                        <span class="chip bg-color">Verilog</span>
                    </a>
                    
                    <a href="/tags/RISC-V/">
                        <span class="chip bg-color">RISC-V</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>


<script>
    $('#articleContent').on('copy', function (e) {
        // IE8 or earlier browser is 'undefined'
        if (typeof window.getSelection === 'undefined') return;

        var selection = window.getSelection();
        // if the selection is short let's not annoy our users.
        if (('' + selection).length < Number.parseInt('250')) {
            return;
        }

        // create a div outside of the visible area and fill it with the selected text.
        var bodyElement = document.getElementsByTagName('body')[0];
        var newdiv = document.createElement('div');
        newdiv.style.position = 'absolute';
        newdiv.style.left = '-99999px';
        bodyElement.appendChild(newdiv);
        newdiv.appendChild(selection.getRangeAt(0).cloneContents());

        // we need a <pre> tag workaround.
        // otherwise the text inside "pre" loses all the line breaks!
        if (selection.getRangeAt(0).commonAncestorContainer.nodeName === 'PRE') {
            newdiv.innerHTML = "<pre>" + newdiv.innerHTML + "</pre>";
        }

        var url = document.location.href;
        newdiv.innerHTML += '<br />'
            + '来源: dzhang&#39;s blog<br />'
            + '文章作者: dzhang<br />'
            + '文章链接: <a href="' + url + '">' + url + '</a><br />'
            + '本文章著作权归作者所有，任何形式的转载都请注明出处。';

        selection.selectAllChildren(newdiv);
        window.setTimeout(function () {bodyElement.removeChild(newdiv);}, 200);
    });
</script>


<!-- 代码块功能依赖 -->
<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/codeBlock/codeShrink.js"></script>


    

</main>




    <footer class="page-footer bg-color">
    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2023</span>
            
            <span id="year">2023</span>
            <a href="/about" target="_blank">dzhang</a>
            <!-- |&nbsp;Powered by&nbsp;<a href="https://haaazhng.github.io/about/" target="_blank">dzhang</a> -->
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">11.3k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2023";
                    var startMonth = "4";
                    var startDate = "3";
                    var startHour = "";
                    var startMinute = "";
                    var startSecond = "";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Haaazhng" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:dzhang0426@163.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2983859387" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2983859387" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/materialize/materialize.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/aos/aos.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    
    <script type="text/javascript" color="0,0,255"
        pointColor="127,127,0" opacity='0.7'
        zIndex="-1" count="150"
        src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/background/canvas-nest.js"></script>
    

    

    
    <script type="text/javascript" src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/background/ribbon-dynamic.js" async="async"></script>
    

    
    <script src="https://cdn.jsdelivr.net/gh/Haaazhng/Haaazhng.github.io/libs/instantpage/instantpage.js" type="module"></script>
    

    <!-- 雪花特效 -->
    
        <script type="text/javascript" src="/libs/others/snow.js"></script>
        
    

        <script type="text/javascript"> var OriginTitile = document.title,

            st; document.addEventListener("visibilitychange", function () {
            
            document.hidden ? (document.title = "Σ(っ °Д °;)っ咿呀，崩溃啦！",
            
            clearTimeout(st)) : (document.title = "φ(゜▽゜*)♪咦，又好了！", st =
            
            setTimeout(function () { document.title = OriginTitile }, 3e3)) })
            
            </script>
</body>

</html>
